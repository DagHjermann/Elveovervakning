---
title: "03 Make pie maps"
output: html_document
---

Put pies on maps    

## 0. Prerequisites
### a. Libs + map
```{r}
library(tidyverse)  # filter, group_by, summary, etc.
library(gridGraphics)
library(maps)       # Norway map (NOTE: must be loaded after tidyverse)
library(readxl)
map_norway <- map_data("world", "Norway")
map_norway_h <- readRDS("Data_input/map_norway_hires.RData")

library(mapproj)    # mapproject
library(ggrepel)    # geom_text_repel()
library(sp)         # SpatialPoints(), CRS(), spTransform()
library(ggimage)    # geom_subview(), theme_transparent()
```

### b. 
```{r}
source("03_map_pie_functions.R")
```



## 2. Data
### a. Read data
```{r}
# df_stations <- read_excel("Data_input/StasonsOgPrøvetakingsoversiktElveovervåking_30_10.xlsx")

# This one has 62 REI2 and 63 REI3 ("Fish Reisa 2" and "Fish Reisa 3") deleted, and 
#    fish added to 43. REI1 and 44. REI 2
df_stations <- read_excel("Data_input/StasonsOgPrøvetakingsoversiktElveovervåking_07_11.xlsx")
```

### b. Convert UTM to Lang/Lot 
```{r}
df_stations <- utm2longlat(df_stations, "X-koordinat", "Y-koordinat", "Sone", 
                           return_entire_dataframe = TRUE) %>%
  arrange(Rapportnavn)
```

### d. Test map
```{r}
df <- data.frame(long = 10.66, lat = 59.92)
gg <- ggplot(df_stations, aes(Long, Lat)) +
    annotation_map(map_norway, aes(long, lat), fill = "grey60") +
  geom_point() +
  geom_point(data = df_stations %>% filter(Long > 7 & Lat < 61), color = "red")+
  geom_point(data = df_stations %>% filter(Long < 7 & Lat < 63), color = "blue") +
  geom_point(data = df_stations %>% filter(Long > 16 & Lat > 68), color = "green") +
  coord_map("lambert", parameters = c(64, 12), xlim = c(-1,30), ylim = c(57, 72))
gg

```

## 3. Maps, define pies from data
```{r, fig.height=11}

vars <- c("Fisk", "Bunndyr", "Begroingsalger", "Fysisk-kjemiske kvalitets elementer", 
          "Vannregion spesifikke stoffer", "Prioriterte stoffer")
colorscheme1 <- c("darkorchid2", "darkorchid3", "darkorchid4", "brown2", "brown3", "brown4")

make_pie_linenumber <- function(i)
  make_pie(!is.na(df_stations[i, vars]))
# make_pie_linenumber(20)

pies <- 1:nrow(df_stations) %>% purrr::map(~make_pie_linenumber(.))
length(pies)
# pies[[20]]

df_pies <- data_frame(x = df_stations[["Long"]],
                 y = df_stations[["Lat"]],
                 label = df_stations[["Rapportnavn"]],
                 pie = pies
)
# df[2,]$pie
```

## 4. Map, all of Norway
### a. Just pies
```{r, fig.height=11}
# Define two points in lower left and upper right corner (just used to set the drawing canvas)
df_range <- data.frame(x = c(5.72, 31), y = c(58.14, 71))

df_pies$width = 0.7    # Sets size of pies
df_pies$height = 0.3   

gg <- ggplot(data=df_range, aes(x, y)) + 
  geom_blank() +
  annotation_map(map_norway_h, aes(long, lat), fill = "darkolivegreen3") +
  geom_subview(aes(x=x, y=y, subview=pie, width=width, height=height), data=df_pies)
# gg
ggsave("Figures/03_Map_elements_01.png", gg, width = 10, height = 11, dpi = 500)
```

### b. Pies and river names (using mean)
```{r}
df_river <- df_stations %>%
  group_by(Elv) %>%
  summarise(Long = mean(Long), Lat = mean(Lat))

gg <- ggplot(data=df_range, aes(x, y)) + 
  geom_blank() +
  annotation_map(map_norway_h, aes(long, lat), fill = "darkolivegreen3") +
  geom_subview(aes(x=x, y=y, subview=pie, width=width, height=height), data=df_pies) +
  geom_text_repel(data = df_river, aes(Long, Lat, label = Elv), point.padding = 0.5)
# gg
ggsave("Figures/03_Map_elements_02.png", gg, width = 10, height = 11, dpi = 500)
```

### c. Pies and river names (using "Elv_kart")
```{r}
df_pies$width = 0.7    # Sets size of pies
df_pies$height = 0.3   

gg1 <- ggplot(data=df_range, aes(x, y)) + 
  geom_blank() +
  annotation_map(map_norway_h, aes(long, lat), fill = "darkolivegreen3") +
  geom_subview(aes(x=x, y=y, subview=pie, width=width, height=height), data=df_pies) +
  geom_text_repel(data = df_stations, aes(Long, Lat, label = Elv_kart), point.padding = 0.5)

gg <- gg1 +
   annotate("text", x = 27.5, y = 70.35,label = "Tanaelva", angle = 20) +
   annotate("text", x = 21, y = 69.5,label = "Reisaelva", angle = -48) 
#   annotate("text", x = 9.5, y = 59.25,label = "Numedalslågen", angle = -70, adj = 0.2) + 
#   annotate("text", x = 9.4, y = 60,label = "Drammenselva", angle = 0, adj = 1.0) +
#   annotate("segment", x = 9.45, xend = 9.7, y = 60, yend = 59.9) +
#   annotate("text", x = 11.75, y = 59.75,label = "Glomma", angle = 70) +
#    annotate("text", x = 27.5, y = 70.35,label = "Tanaelva", angle = 20) 

ggsave("Figures/03_Map_elements_03.png", gg, width = 10, height = 11, dpi = 500)
  
# For finding coordinates
# gg <- gg1 + geom_vline(xintercept = seq(9,12,0.5)) + geom_hline(yintercept = seq(58, 61, 0.5))
# ggsave("Figures/03_Map_elements_coor.png", gg, width = 10, height = 11, dpi = 150)

```


### e. SE Norway  
Including labels placed manually
```{r, fig.height=7}

# Define two points in lower left and upper right corner (just used to set the drawing canvas)
df_pies$width = 0.3    # Sets size of pies
df_pies$height = 0.15   

xlimits <- c(7,12)
ylimits <- c(57.6, 60.7)
sel <- with(df_pies, 
        x > xlimits[1] & x < xlimits[2] &
        y > ylimits[1] & y < ylimits[2])

gg1 <- ggplot(data=df_range[sel,], aes(x, y)) + 
  geom_blank() +
  annotation_map(map_norway_h, aes(long, lat), fill = "darkolivegreen3") +
  geom_subview(aes(x=x, y=y, subview=pie, width=width, height=height), data=df_pies[sel,]) +
  # geom_text_repel(data = df_stations[sel,], aes(Long, Lat, label = Elv_kart), point.padding = 0.5) +
  coord_cartesian(xlim = xlimits, ylim = ylimits)

gg <- gg1 +
  annotate("text", x = 9.75, y = 59.25,label = "Numedalslågen", angle = -65, adj = 0.5, size = 6) + 
  annotate("text", x = 9.82, y = 59.82, label = "Drammenselva", angle = 0, adj = 1.0, size = 6) +
  annotate("text", x = 9.7, y = 60.1, label = "Snarumselva", angle = 0, adj = 1.0, size = 6) +
  annotate("text", x = 10.25, y = 60.35, label = "Randselva", angle = 0, adj = 0.5, size = 6) +
  annotate("text", x = 10.85, y = 60.05, label = "Alna", angle = 0, adj = 0.5, size = 6) +
  annotate("text", x = 11.4, y = 59.75,label = "G l o m m a", angle = 80, size = 6) +
  annotate("text", x = 9.0, y = 58.5,label = "Storelva", angle = -45, adj = 0, size = 6) + 
  annotate("text", x = 8.7, y = 58.3,label = "Nidelva", angle = -45, adj = 0, size = 6) + 
  annotate("text", x = 8.2, y = 58.15,label = "Tovdalselva", angle = -45, adj = 0, size = 6) +
  annotate("text", x = 8.0, y = 58.1,label = "Otra", angle = -45, adj = 0, size = 6)  +
  annotate("text", x = 7.6, y = 58.0,label = "Mandalselva", angle = -45, adj = 0, size = 6) 
# gg
# gg + geom_vline(xintercept = seq(7.5,12,0.5)) + geom_hline(yintercept = seq(58, 61, 0.5))
ggsave("Figures/03_Map_elements_SE_01.png", gg, width = 8, height = 8, dpi = 500)

```

### f. W Norway  
Including labels using ggrepel
```{r, fig.height=7}
# Define two points in lower left and upper right corner (just used to set the drawing canvas)
df_pies$width = 0.3    # Sets size of pies
df_pies$height = 0.15   

  # geom_point(data = df_stations %>% filter(Long < 7 & Lat < 63), color = "blue") +
xlimits <- c(4.5, 7.5)
ylimits <- c(58.5, 63)
df_pies_s <- df_pies %>% 
  filter(x > xlimits[1] & x < xlimits[2] &
           y > ylimits[1] & y < ylimits[2])

gg <- ggplot(data=df_range, aes(x, y)) + 
  geom_blank() +
  annotation_map(map_norway_h, aes(long, lat), fill = "darkolivegreen3") +
  geom_subview(aes(x=x, y=y, subview=pie, width=width, height=height), data=df_pies_s) + 
  geom_text_repel(data = df_pies_s, aes(label = label), point.padding = 0.5) +
  coord_cartesian(xlim = xlimits, ylim = ylimits)
ggsave("Figures/02_Map_elements_W_01.png", gg, width = 5, height = 10, dpi = 500)
# gg
```


### g. Troms/Finnmark  
Including labels using ggrepel
```{r, fig.height=7}
# Define two points in lower left and upper right corner (just used to set the drawing canvas)
df_pies$width = 0.3    # Sets size of pies
df_pies$height = 0.15   

  # geom_point(data = df_stations %>% filter(Long < 7 & Lat < 63), color = "blue") +
xlimits <- c(17,31)
ylimits <- c(68, 71)
df_pies_s <- df_pies %>% 
  filter(x > xlimits[1] & x < xlimits[2] &
           y > ylimits[1] & y < ylimits[2])

gg <- ggplot(data=df_range, aes(x, y)) + 
  geom_blank() +
  annotation_map(map_norway_h, aes(long, lat), fill = "darkolivegreen3") +
  geom_subview(aes(x=x, y=y, subview=pie, width=width, height=height), data=df_pies_s) + 
  geom_text_repel(data = df_pies_s, aes(label = label), point.padding = 0.5) +
  coord_cartesian(xlim = xlimits, ylim = ylimits)
ggsave("Figures/02_Map_elements_Finnmark_01.png", gg, width = 8, height = 5, dpi = 500)
# gg
```


### g. Reisa  
Including labels using ggrepel
```{r, fig.height=7}
# Define two points in lower left and upper right corner (just used to set the drawing canvas)
df_pies$width = 0.15    # Sets size of pies
df_pies$height = 0.07   

  # geom_point(data = df_stations %>% filter(Long < 7 & Lat < 63), color = "blue") +
xlimits <- c(20, 24)
ylimits <- c(69, 70)
df_pies_s <- df_pies %>% 
  filter(x > xlimits[1] & x < xlimits[2] &
           y > ylimits[1] & y < ylimits[2])

gg <- ggplot(data=df_range, aes(x, y)) + 
  geom_blank() +
  annotation_map(map_norway_h, aes(long, lat), fill = "darkolivegreen3") +
  geom_subview(aes(x=x, y=y, subview=pie, width=width, height=height), data=df_pies_s) + 
  geom_text_repel(data = df_pies_s, aes(label = label), point.padding = 0.5) +
  coord_cartesian(xlim = xlimits, ylim = ylimits)
ggsave("Figures/02_Map_elements_reisa_01.png", gg, width = 8, height = 5, dpi = 500)
# gg
```

### 6. Legend
```{r}
# Note: 'labels' is slighlty change compared to vars
labels <- c("Fisk", "Bunndyr", "Begroingsalger", "Fysisk-kjemiske kvalitetselementer", 
          "Vannregionspesifikke stoffer", "Prioriterte stoffer")
x <- rep(1,6)
names(x) <- labels

png("Figures/03_Pielegend_01.png", width = 40*0.7, height = 20*0.7, unit = "cm", res = 300)
pie(x, col = colorscheme1, init.angle = 90, cex = 1.6)
dev.off()

```




